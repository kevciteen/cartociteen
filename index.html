<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte fusion ‚Äì COPRO + DVF + Tertiaire</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      position: absolute;
      top: 0; bottom: 0; right: 0; left: 0;
    }

    /* ==========================
       √âCRAN D‚ÄôOUVERTURE
    =========================== */
    .opening-screen {
      position: fixed;
      z-index: 20000;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: linear-gradient(
        135deg,
        #ffffff 0%,
        #f5faf7 35%,
        #d9f5e5 65%,
        #16a34a 100%
      );
      color: #0f172a;
    }

    .opening-inner {
      max-width: 640px;
      width: 100%;
      background: #ffffffee;
      border-radius: 18px;
      padding: 24px 24px 20px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.18);
      border: 1px solid rgba(22,163,74,0.25);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .opening-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .opening-logo-wrap {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0 0, #16a34a 45%, #0d9488 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .opening-logo {
      max-width: 70%;
      max-height: 70%;
      display: block;
    }

    .opening-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .opening-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #065f46;
    }

    .opening-subtitle {
      font-size: 12px;
      color: #4b5563;
    }

    .opening-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.5;
    }

    .opening-body strong {
      color: #047857;
      font-weight: 600;
    }

    .opening-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
      color: #4b5563;
    }

    .opening-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .badge-env {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(22,163,74,0.4);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #065f46;
      background: #ecfdf5;
    }

    .opening-button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #064e3b;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 25px rgba(34,197,94,0.4);
      transition: transform 0.08s ease-out, box-shadow 0.12s ease-out, background 0.12s;
    }

    .opening-button:hover {
      background: #16a34a;
      box-shadow: 0 10px 30px rgba(34,197,94,0.55);
      transform: translateY(-1px);
    }

    .opening-button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(34,197,94,0.4);
    }

    .opening-hint {
      font-size: 11px;
      color: #6b7280;
    }

    .opening-screen.hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-out;
    }

    /* ==========================
       BARRE DE RECHERCHE
    =========================== */
    .search-panel {
      position: absolute;
      z-index: 10000;
      background: #ffffffee;
      backdrop-filter: blur(4px);
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid #dde2ea;
      font-size: 13px;
    }

    .search-panel.expanded {
      top: 10px;
      left: 10px;
      width: 520px;
    }

    .search-panel.mini {
      top: 10px;
      left: 10px;
      width: 260px;
      padding: 8px 10px;
    }

    .search-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eef1f5;
    }

    .search-logo-wrap {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-logo {
      height: 28px;
      display: block;
    }

    .search-header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .search-brand {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #111827;
    }

    .search-subtitle {
      font-size: 11px;
      color: #6b7280;
    }

    .search-panel.mini .search-subtitle {
      display: none;
    }

    .search-panel.mini .search-logo {
      height: 22px;
    }

    .search-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .search-input, .search-select {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #cbd2e1;
      font-size: 13px;
      outline: none;
      background-color: #fff;
      transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
    }

    .search-input:focus, .search-select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.25);
    }

    .search-status {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
      line-height: 1.3;
      white-space: pre-line;
    }

    .search-icon-wrapper {
      position: relative;
      flex: 1;
    }

    .search-icon {
      position: absolute;
      right: 10px;
      top: 7px;
      font-size: 14px;
      color: #9ca3af;
      pointer-events: none;
    }

    .filter-label {
      font-size: 11px;
      color: #4b5563;
      margin-bottom: 2px;
    }

    .search-button {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #16a34a;
      background: #16a34a;
      color: white;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s, color 0.15s, border-color 0.15s;
      box-shadow: 0 1px 4px rgba(22,163,74,0.4);
      white-space: nowrap;
    }

    .search-button:hover {
      background: #15803d;
      border-color: #15803d;
      box-shadow: 0 2px 6px rgba(22,163,74,0.5);
    }

    .search-button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(22,163,74,0.4);
    }

    .search-button-secondary {
      background: #ffffff;
      color: #111827;
      border-color: #e5e7eb;
      box-shadow: none;
    }

    .search-button-secondary:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .search-panel.mini #advancedFilters {
      display: none;
    }

    .leaflet-control-layers {
      font-size: 12px;
    }

    /* ==========================
       TOGGLE FOND OSM / SAT
    =========================== */
    .leaflet-control-basemap-toggle a {
      width: 34px;
      height: 26px;
      line-height: 26px;
      text-align: center;
      text-decoration: none;
      display: block;
      background: #fff;
      color: #111827;
      font-size: 11px;
      border-bottom: 1px solid #ccc;
    }

    .leaflet-control-basemap-toggle a:last-child {
      border-bottom: none;
    }

    .leaflet-control-basemap-toggle a.active {
      background: #16a34a;
      color: #fff;
      font-weight: 600;
    }
  </style>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Google Maps JS API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4izaTwbsKKyjVuOJ2Bu0ZHfZRg7mv-ZA&libraries=places"></script>
  <!-- Plugin Leaflet pour utiliser Google comme fond -->
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.11.2/dist/Leaflet.GoogleMutant.js"></script>
</head>
<body>

<!-- √âCRAN D‚ÄôOUVERTURE -->
<div id="openingScreen" class="opening-screen">
  <div class="opening-inner">
    <div class="opening-header">
      <div class="opening-logo-wrap">
        <img src="assets/LOGO CITEEN_RVB-min.png" alt="Citeen" class="opening-logo">
      </div>
      <div class="opening-title-block">
        <div class="opening-title">Citeen Cartographie</div>
        <div class="opening-subtitle">
          Immeubles d'habitation & parc tertiaire ‚Äì lecture territoriale augment√©e
        </div>
      </div>
    </div>

    <div class="opening-body">
      Explorez le patrimoine b√¢ti en croisant les <strong>donn√©es de copropri√©t√©</strong>,
      les <strong>mutations DVF</strong>, les <strong>performances √©nerg√©tiques</strong>
      et les <strong>actifs tertiaires</strong>.
      <br><br>
      Bleu : parc r√©sidentiel en copropri√©t√©. Orange : parc tertiaire (ERP, bureaux, commerces...).
    </div>

    <div class="opening-footer">
      <div class="opening-hint">
        √âtape 1 : acc√©der √† la carte<br>
        √âtape 2 : lancer vos recherches et exporter les r√©sultats copro.
      </div>
      <div class="opening-actions">
        <span class="badge-env">Pr√©-s√©rie</span>
        <button id="enterAppBtn" class="opening-button">
          Acc√©der √† la carte
          <span>‚ü∂</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CARTE -->
<div id="map"></div>

<!-- PANNEAU DE RECHERCHE -->
<div class="search-panel expanded" id="searchPanel">

  <!-- HEADER CITEEN -->
  <div class="search-header">
    <div class="search-logo-wrap">
      <img
        src="assets/LOGO CITEEN_RVB-min.png"
        alt="Citeen"
        class="search-logo"
      />
    </div>
    <div class="search-header-text">
      <div class="search-brand">Citeen</div>
      <div class="search-subtitle">Recherche d'immeuble ¬∑ COPRO ¬∑ DVF</div>
    </div>
  </div>

  <!-- CHAMP PRINCIPAL -->
  <div class="search-row">
    <div class="search-icon-wrapper">
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Nom de copro, adresse, voie, commune‚Ä¶"
      />
      <span class="search-icon">üîç</span>
    </div>
  </div>

  <div id="advancedFilters">
    <!-- SYNDIC (copro uniquement) -->
    <div class="search-row">
      <div style="flex:1; display:flex; flex-direction:column;">
        <span class="filter-label">Nom du syndic (copro)</span>
        <input
          type="text"
          id="syndicInput"
          class="search-input"
          placeholder="Ex : NEXITY, FONCIA‚Ä¶"
        />
      </div>
    </div>

    <!-- CODE POSTAL + TYPE BIEN -->
    <div class="search-row">
      <div style="flex:0.7; display:flex; flex-direction:column;">
        <span class="filter-label">Code postal</span>
        <input
          type="text"
          id="cpInput"
          class="search-input"
          placeholder="Ex : 75014"
        />
      </div>

      <div style="flex:1; display:flex; flex-direction:column;">
        <span class="filter-label">Type de bien (DVF - copro)</span>
        <select id="typeBienFilter" class="search-select">
          <option value="">Tous</option>
          <option value="Appartement">Appartement</option>
          <option value="Maison">Maison</option>
          <option value="D√©pendance">D√©pendance</option>
          <option value="Local">Local</option>
        </select>
      </div>
    </div>

    <!-- ANN√âE CONSTRUCTION -->
    <div class="search-row">
      <div style="flex:1; display:flex; flex-direction:column;">
        <span class="filter-label">Ann√©e construction (min)</span>
        <input
          type="number"
          id="anneeMinFilter"
          class="search-input"
          placeholder="ex : 1950"
        />
      </div>
      <div style="flex:1; display:flex; flex-direction:column;">
        <span class="filter-label">Ann√©e construction (max)</span>
        <input
          type="number"
          id="anneeMaxFilter"
          class="search-input"
          placeholder="ex : 2000"
        />
      </div>
    </div>

    <!-- PRIX + DPE -->
    <div class="search-row">
      <div style="flex:1.3; display:flex; flex-direction:column;">
        <span class="filter-label">Prix de vente (DVF - copro) ‚Ç¨ min / max</span>
        <div class="search-row">
          <input
            type="number"
            id="prixMinFilter"
            class="search-input"
            placeholder="min"
          />
          <input
            type="number"
            id="prixMaxFilter"
            class="search-input"
            placeholder="max"
          />
        </div>
      </div>

      <div style="flex:0.7; display:flex; flex-direction:column;">
        <span class="filter-label">Note DPE (logts / tertiaire)</span>
        <select id="noteDpeFilter" class="search-select">
          <option value="">Toutes</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="G">G</option>
        </select>
      </div>
    </div>
  </div>

  <!-- BOUTONS -->
  <div class="search-row" style="justify-content:flex-end; margin-top:4px; gap:8px;">
    <button id="resetBtn" class="search-button search-button-secondary">R√©initialiser</button>
    <button id="exportBtn" class="search-button search-button-secondary">Exporter (CSV)</button>
    <button id="searchBtn" class="search-button">Lancer la recherche</button>
  </div>

  <div id="status" class="search-status">Chargement des CSV‚Ä¶</div>
</div>

<script>
/* -----------------------------------------------------
   PARAM√àTRES
------------------------------------------------------ */
const CSV_FILE_COPRO = "donne carte avec fusion.csv";
const CSV_FILE_TERTIAIRE = "donnees_tertiaire.csv"; // adapte le nom si besoin
const MAX_POINTS_DISPLAYED = 50000;

let allRows = [];            // copro complet
let tertiaireRowsAll = [];   // tertiaire complet
let markerLayer;             // couche copro
let tertiaireLayer;          // couche tertiaire
let hasSearched = false;
let searchPanelMinimized = false;
let lastFilteredRows = [];   // pour export CSV copro

let btnOSMRef = null;
let btnSatRef = null;
let currentBase = "osm";

/* -----------------------------------------------------
   CARTE LEAFLET + FONDS OSM + GOOGLE SAT + IDF
------------------------------------------------------ */

// Fond OSM
const baseOSM = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }
);

// Fond Google Satellite via GoogleMutant
const googleSat = L.gridLayer.googleMutant({
  type: "satellite",
  maxZoom: 21
});

// Initialisation de la carte avec OSM par d√©faut
const map = L.map('map', {
  center: [48.8566, 2.3522],
  zoom: 11,
  layers: [baseOSM]
});

// Limitation au p√©rim√®tre √éle-de-France
const boundsIDF = [
  [48.0, 1.4],  // Sud-Ouest IDF
  [49.2, 3.6]   // Nord-Est IDF
];
map.setMaxBounds(boundsIDF);
map.setMinZoom(9);                 // emp√™che de voir toute la France
map.options.maxBoundsViscosity = 1.0;
map.fitBounds(boundsIDF);

// Couches de points
markerLayer    = L.layerGroup().addTo(map); // copro
tertiaireLayer = L.layerGroup().addTo(map); // tertiaire

// Contr√¥le des couches (on garde aussi la possibilit√© par d√©faut)
const baseLayers = {
  "Fond OSM": baseOSM,
  "Satellite Google": googleSat
};

const overlays = {
  "Copropri√©t√©s (bleu)": markerLayer,
  "Tertiaire (orange)": tertiaireLayer
};

L.control.layers(baseLayers, overlays, {
  position: "topright",
  collapsed: false
}).addTo(map);

/* -----------------------------------------------------
   TOGGLE FOND OSM / SATELLITE
------------------------------------------------------ */
function setBaseLayer(mode) {
  currentBase = mode;

  if (mode === "osm") {
    if (map.hasLayer(googleSat)) map.removeLayer(googleSat);
    if (!map.hasLayer(baseOSM)) map.addLayer(baseOSM);
    if (btnOSMRef && btnSatRef) {
      btnOSMRef.classList.add("active");
      btnSatRef.classList.remove("active");
    }
  } else if (mode === "sat") {
    if (map.hasLayer(baseOSM)) map.removeLayer(baseOSM);
    if (!map.hasLayer(googleSat)) map.addLayer(googleSat);
    if (btnOSMRef && btnSatRef) {
      btnOSMRef.classList.remove("active");
      btnSatRef.classList.add("active");
    }
  }
}

const BaseMapToggle = L.Control.extend({
  options: { position: 'topleft' },
  onAdd: function(map) {
    const container = L.DomUtil.create('div', 'leaflet-control leaflet-bar leaflet-control-basemap-toggle');

    btnOSMRef = L.DomUtil.create('a', '', container);
    btnOSMRef.href = '#';
    btnOSMRef.innerHTML = 'OSM';
    btnOSMRef.classList.add('active');

    btnSatRef = L.DomUtil.create('a', '', container);
    btnSatRef.href = '#';
    btnSatRef.innerHTML = 'Sat';

    L.DomEvent.disableClickPropagation(container);

    L.DomEvent.on(btnOSMRef, 'click', function (e) {
      L.DomEvent.preventDefault(e);
      setBaseLayer('osm');
    });

    L.DomEvent.on(btnSatRef, 'click', function (e) {
      L.DomEvent.preventDefault(e);
      setBaseLayer('sat');
    });

    return container;
  }
});

map.addControl(new BaseMapToggle());

/* -----------------------------------------------------
   LECTURE DU CSV COPRO
------------------------------------------------------ */
Papa.parse(CSV_FILE_COPRO, {
  download: true,
  header: true,
  dynamicTyping: true,
  skipEmptyLines: true,
  delimiter: ";",
  complete: function(result) {
    allRows = result.data || [];
    const withCoords = allRows.filter(r => getLatLonCopro(r) !== null).length;

    document.getElementById("status").innerText =
      "CSV copro charg√©.\nLignes : " + allRows.length +
      "\nAvec lat/long (COPRO ou DVF) : " + withCoords +
      "\nAucun point affich√©. Lancez une recherche.";
  },
  error: function(err) {
    document.getElementById("status").innerText = "Erreur CSV copro : " + err;
    console.error("Erreur lecture CSV COPRO :", err);
  }
});

/* -----------------------------------------------------
   LECTURE DU CSV TERTIAIRE (sans affichage initial)
------------------------------------------------------ */
Papa.parse(CSV_FILE_TERTIAIRE, {
  download: true,
  header: true,
  dynamicTyping: true,
  skipEmptyLines: true,
  delimiter: ";",
  complete: function(result) {
    tertiaireRowsAll = result.data || [];
    console.log("CSV tertiaire charg√©. Lignes :", tertiaireRowsAll.length);
    document.getElementById("status").innerText +=
      "\nCSV tertiaire charg√©. Lignes : " + tertiaireRowsAll.length +
      "\nPoints tertiaires masqu√©s tant qu'aucune recherche n'est lanc√©e.";
  },
  error: function(err) {
    console.error("Erreur lecture CSV TERTIAIRE :", err);
  }
});

/* -----------------------------------------------------
   R√âCUP√àRE LAT / LON COPRO
------------------------------------------------------ */
function getLatLonCopro(row) {
  let lat = row["lat_COPRO"];
  let lon = row["long_COPRO"];

  if ((lat === undefined || lat === null || lat === "") &&
      (lon === undefined || lon === null || lon === "")) {
    lat = row["latitude_DVF"];
    lon = row["longitude_DVF"];
  }

  lat = parseFloat(String(lat).replace(",", "."));
  lon = parseFloat(String(lon).replace(",", "."));

  if (!isFinite(lat) || !isFinite(lon)) return null;
  return [lat, lon];
}

/* -----------------------------------------------------
   AFFICHAGE POINTS COPRO
------------------------------------------------------ */
function renderMarkers(rows) {
  markerLayer.clearLayers();

  let displayed = 0;
  const bounds = [];

  rows.forEach(row => {
    const coords = getLatLonCopro(row);
    if (!coords) return;
    if (displayed >= MAX_POINTS_DISPLAYED) return;

    const [lat, lon] = coords;

    const adrImmeuble =
      row["adresse_de_reference_COPRO"] ||
      row["Adresse"] ||
      ((row["adresse_numero_DVF"] || "") + " " + (row["adresse_nom_voie_DVF"] || ""));

    const cp = row["code_postal_adresse_de_reference_COPRO"] ||
               row["code postal"] ||
               row["code_postal_DVF"] ||
               "";

    const com = row["Commune"] || "";

    const nomCopro = row["nom_d_usage_de_la_copropriete_COPRO"] || "Copropri√©t√©";
    const syndicNom = row["raison_sociale_du_representant_legal_COPRO"] || "Non renseign√©";
    const syndicType = row["type_de_syndic_benevole_professionnel_non_connu_COPRO"] || "Non renseign√©";

    const typeBat = row["type batiment"] || "Non renseign√©";
    const anneeConstr = row["annee construction"] || "Non renseign√©e";
    const periodeConstr =
      row["periode_de_construction_COPRO"] ||
      row["periode de construction"] ||
      "Non renseign√©e";

    const typeChauffInst =
      row["type d'installation chauffage"] ||
      row["type_installation_chauffage_n1_DPE"] ||
      "Non renseign√©";

    const typeChauffEnergie =
      row["type energie principale chauffage"] ||
      "Non renseign√©";

    const typeEcsInst =
      row["type d'installation ecs"] ||
      "Non renseign√©";

    const typeEcsEnergie =
      row["type_energie_principale_ecs_DPE"] ||
      "Non renseign√©";

    const numDpe   = row["Numero dpe"] || "Non renseign√©";
    const noteDpe  = row["Etiquette Dpe"] || "Non renseign√©e";
    const dateDpe  = row["Date Dpe"] || "Non renseign√©e";

    const dateVente = row["date_mutation_DVF"] || "Non renseign√©e";

    let prixVente  = row["prix de vente_DVF"];
    if (prixVente && !isNaN(Number(String(prixVente).replace(",", ".")))) {
      prixVente = Number(String(prixVente).replace(",", ".")).toLocaleString("fr-FR") + " ‚Ç¨";
    } else {
      prixVente = "Non renseign√©";
    }

    const popup = `
      <div style="font-size:13px; line-height:1.4; max-width:280px;">
        <h3 style="margin:0; font-size:14px;">üè¢ ${nomCopro}</h3>

        <p style="margin:4px 0;">
          <strong>üìç Adresse :</strong><br>
          ${adrImmeuble || "Non renseign√©e"}<br>
          ${cp} ${com}
        </p>

        <hr>

        <p style="margin:4px 0;">
          <strong>üë§ Syndic :</strong><br>
          ${syndicNom}<br>
          <em>Type de syndic : ${syndicType}</em>
        </p>

        <hr>

        <p style="margin:4px 0;">
          <strong>üèóÔ∏è B√¢timent :</strong><br>
          Type de b√¢timent : ${typeBat}<br>
          Ann√©e de construction : ${anneeConstr}<br>
          P√©riode de construction : ${periodeConstr}
        </p>

        <p style="margin:4px 0;">
          <strong>üî• Chauffage / ECS :</strong><br>
          Type de chauffage : ${typeChauffInst}<br>
          √ânergie de chauffage : ${typeChauffEnergie}<br>
          Type d'ECS : ${typeEcsInst}<br>
          √ânergie ECS : ${typeEcsEnergie}
        </p>

        <hr>

        <p style="margin:4px 0;">
          <strong>üìù DPE :</strong><br>
          Num√©ro de DPE : ${numDpe}<br>
          Note DPE : ${noteDpe}<br>
          Date de DPE : ${dateDpe}
        </p>

        <hr>

        <p style="margin:4px 0;">
          <strong>üí∂ Vente :</strong><br>
          Prix de vente : ${prixVente}<br>
          Date de vente : ${dateVente}
        </p>
      </div>
    `;

    const marker = L.circleMarker([lat, lon], {
      radius: 5,
      color: "#0044ff",
      fillColor: "#3388ff",
      fillOpacity: 0.85,
      weight: 1
    }).bindPopup(popup);

    markerLayer.addLayer(marker);
    bounds.push([lat, lon]);
    displayed++;
  });

  if (bounds.length > 0) {
    map.fitBounds(bounds, { padding: [20, 20] });
  }
}

/* -----------------------------------------------------
   AFFICHAGE POINTS TERTIAIRE
------------------------------------------------------ */
function renderTertiaireMarkers(rows) {
  tertiaireLayer.clearLayers();

  rows.forEach(row => {
    let lat = row["latitude"];
    let lon = row["longitude"];

    lat = parseFloat(String(lat).replace(",", "."));
    lon = parseFloat(String(lon).replace(",", "."));
    if (!isFinite(lat) || !isFinite(lon)) return;

    const secteur = row["secteur_activite"] || "";
    const typeErp = row["tr013_type_erp_type"] || "";
    const titre = secteur || typeErp || "Site tertiaire";

    const geoAdresse = row["geo_adresse"] || "";
    const adresseRecomposee =
      (row["numero_rue"] ? row["numero_rue"] + " " : "") +
      (row["nom_rue"] || "") +
      ((row["code_postal"] || row["code_postal"] === 0) ? ", " + row["code_postal"] : "") +
      (row["commune"] ? " " + row["commune"] : "");

    const adresseFinale = geoAdresse || adresseRecomposee || "Adresse non renseign√©e";

    const anneeConstr = row["annee_construction"] || "Non renseign√©e";
    const surface = row["surface_habitable"] || "Non renseign√©e";
    const departement = row["tv016_departement_id"] || "";
    const zoneHiver = row["tv017_zone_hiver_code"] || "";

    const numDpe   = row["numero_dpe"] || "Non renseign√©";
    const methode  = row["nom_methode_dpe"] || "Non renseign√©e";
    const dateDpe  = row["date_etablissement_dpe"] || "Non renseign√©e";

    const conso    = row["consommation_energie"] || "Non renseign√©e";
    const classeConso = row["classe_consommation_energie"] || "Non renseign√©e";
    const ges      = row["estimation_ges"] || "Non renseign√©e";
    const classeGes = row["classe_estimation_ges"] || "Non renseign√©e";

    const organisme = row["organisme_certificateur"] || "Non renseign√©";
    const adrOrg    = row["adresse_organisme_certificateur"] || "";

    const batiment  = row["batiment"] || "";
    const escalier  = row["escalier"] || "";
    const etage     = row["etage"] || "";
    const porte     = row["porte"] || "";
    const lot       = row["numero_lot"] || "";
    const etatAvancement = row["etat_avancement"] || "";

    const popup = `
      <div style="font-size:13px; line-height:1.4; max-width:280px;">
        <h3 style="margin:0; font-size:14px;">üè¢ ${titre}</h3>

        <p style="margin:4px 0;">
          <strong>üìç Adresse :</strong><br>
          ${adresseFinale}<br>
          ${departement ? "D√©partement : " + departement : ""}
        </p>

        ${ (batiment || escalier || etage || porte || lot)
          ? `<p style="margin:4px 0;">
               <strong>üì¶ Localisation interne :</strong><br>
               ${batiment ? "B√¢timent : " + batiment + "<br>" : ""}
               ${escalier ? "Escalier : " + escalier + "<br>" : ""}
               ${etage ? "√âtage : " + etage + "<br>" : ""}
               ${porte ? "Porte : " + porte + "<br>" : ""}
               ${lot ? "Lot : " + lot + "<br>" : ""}
             </p>` : ""
        }

        <hr>

        <p style="margin:4px 0;">
          <strong>üèóÔ∏è B√¢timent :</strong><br>
          Ann√©e de construction : ${anneeConstr}<br>
          Surface : ${surface} m¬≤<br>
          ${typeErp ? "Type ERP : " + typeErp + "<br>" : ""}
          ${zoneHiver ? "Zone hiver : " + zoneHiver : ""}
        </p>

        <hr>

        <p style="margin:4px 0;">
          <strong>üîã DPE tertiaire :</strong><br>
          Num√©ro DPE : ${numDpe}<br>
          M√©thode : ${methode}<br>
          Date d'√©tablissement : ${dateDpe}<br>
          Consommation : ${conso} kWhEP/m¬≤.an<br>
          Classe conso : ${classeConso}<br>
          GES : ${ges} kgCO‚ÇÇ/m¬≤.an<br>
          Classe GES : ${classeGes}
        </p>

        <hr>

        <p style="margin:4px 0;">
          <strong>üèõÔ∏è Organisme certificateur :</strong><br>
          ${organisme}<br>
          ${adrOrg}
        </p>

        ${etatAvancement
          ? `<p style="margin:4px 0;">
               <strong>√âtat d'avancement :</strong> ${etatAvancement}
             </p>`
          : ""
        }

        <p style="color:#c2410c; font-weight:600; margin:6px 0 0;">(Site tertiaire)</p>
      </div>
    `;

    const marker = L.circleMarker([lat, lon], {
      radius: 6,
      color: "#ff6d00",
      fillColor: "#ff9100",
      fillOpacity: 0.9,
      weight: 1.5
    }).bindPopup(popup);

    tertiaireLayer.addLayer(marker);
  });
}

/* -----------------------------------------------------
   FILTRE TERTIAIRE (adresse, CP, ann√©e, note DPE)
------------------------------------------------------ */
function filterTertiaireRows() {
  const adresse   = document.getElementById("searchInput").value.toLowerCase().trim();
  const cpFilter  = document.getElementById("cpInput").value.trim();
  const anneeMin  = parseInt(document.getElementById("anneeMinFilter").value, 10);
  const anneeMax  = parseInt(document.getElementById("anneeMaxFilter").value, 10);
  const noteDpe   = document.getElementById("noteDpeFilter").value;

  const filtered = tertiaireRowsAll.filter(row => {
    let lat = row["latitude"];
    let lon = row["longitude"];
    lat = parseFloat(String(lat).replace(",", "."));
    lon = parseFloat(String(lon).replace(",", "."));
    if (!isFinite(lat) || !isFinite(lon)) return false;

    if (adresse) {
      const fullAddress =
        (row["geo_adresse"] || "") +
        (row["nom_rue"] || "") +
        (row["commune"] || "");
      if (!fullAddress.toLowerCase().includes(adresse)) return false;
    }

    if (cpFilter) {
      const rowCp = row["code_postal"] || "";
      if (!String(rowCp).startsWith(cpFilter)) return false;
    }

    const anneeStr = row["annee_construction"];
    const anneeNum = anneeStr ? parseInt(anneeStr, 10) : NaN;

    if (!isNaN(anneeMin) && (isNaN(anneeNum) || anneeNum < anneeMin)) return false;
    if (!isNaN(anneeMax) && (isNaN(anneeNum) || anneeNum > anneeMax)) return false;

    if (noteDpe) {
      const note = (row["classe_consommation_energie"] || "").toString().trim().toUpperCase();
      if (!note.startsWith(noteDpe.toUpperCase())) return false;
    }

    return true;
  });

  return filtered;
}

/* -----------------------------------------------------
   FILTRES COPRO + TERTIAIRE
------------------------------------------------------ */
function applyFilters() {
  const adresse      = document.getElementById("searchInput").value.toLowerCase().trim();
  const syndicFilter = document.getElementById("syndicInput").value.toLowerCase().trim();
  const cpFilter     = document.getElementById("cpInput").value.trim();
  const typeBien     = document.getElementById("typeBienFilter").value;
  const anneeMin     = parseInt(document.getElementById("anneeMinFilter").value, 10);
  const anneeMax     = parseInt(document.getElementById("anneeMaxFilter").value, 10);
  const prixMin      = parseFloat(document.getElementById("prixMinFilter").value);
  const prixMax      = parseFloat(document.getElementById("prixMaxFilter").value);
  const noteDpe      = document.getElementById("noteDpeFilter").value;

  const filteredCopro = allRows.filter(row => {
    const coords = getLatLonCopro(row);
    if (!coords) return false;

    if (adresse) {
      const fullAddress =
        (row["Adresse"] || "") +
        (row["adresse_de_reference_COPRO"] || "") +
        (row["adresse_nom_voie_DVF"] || "");
      if (!fullAddress.toLowerCase().includes(adresse)) return false;
    }

    if (syndicFilter) {
      const syndic = (row["raison_sociale_du_representant_legal_COPRO"] || "").toLowerCase();
      if (!syndic.includes(syndicFilter)) return false;
    }

    if (cpFilter) {
      const rowCp =
        row["code_postal_adresse_de_reference_COPRO"] ||
        row["code postal"] ||
        row["code_postal_DVF"] ||
        "";
      if (!String(rowCp).startsWith(cpFilter)) return false;
    }

    if (typeBien) {
      const t = (row["type_local_DVF"] || "").toLowerCase();
      if (!t.includes(typeBien.toLowerCase())) return false;
    }

    const anneeStr = row["annee construction"];
    const anneeNum = anneeStr ? parseInt(anneeStr, 10) : NaN;

    if (!isNaN(anneeMin) && (isNaN(anneeNum) || anneeNum < anneeMin)) return false;
    if (!isNaN(anneeMax) && (isNaN(anneeNum) || anneeNum > anneeMax)) return false;

    let prix = row["prix de vente_DVF"];
    if (prix !== undefined && prix !== null && prix !== "") {
      prix = parseFloat(String(prix).replace(",", "."));
    } else {
      prix = NaN;
    }

    if (!isNaN(prixMin) && (isNaN(prix) || prix < prixMin)) return false;
    if (!isNaN(prixMax) && (isNaN(prix) || prix > prixMax)) return false;

    if (noteDpe) {
      const note = (row["Etiquette Dpe"] || "").toString().trim().toUpperCase();
      if (!note.startsWith(noteDpe.toUpperCase())) return false;
    }

    return true;
  });

  lastFilteredRows = filteredCopro;
  renderMarkers(filteredCopro);

  const filteredTertiaire = filterTertiaireRows();
  renderTertiaireMarkers(filteredTertiaire);

  document.getElementById("status").innerText =
    `R√©sultats COPRO : ${filteredCopro.length} lignes filtr√©es\n` +
    `R√©sultats TERTIAIRE : ${filteredTertiaire.length} lignes filtr√©es\n` +
    `(Fonds activables en haut √† gauche (OSM/Sat) et en haut √† droite (couches))`;
}

/* -----------------------------------------------------
   EXPORT CSV (r√©sultats copro filtr√©s)
------------------------------------------------------ */
function exportFilteredToCSV() {
  if (!lastFilteredRows || lastFilteredRows.length === 0) {
    alert("Aucune donn√©e filtr√©e √† exporter. Lancez d'abord une recherche sur les copropri√©t√©s.");
    return;
  }

  const csv = Papa.unparse(lastFilteredRows, {
    delimiter: ";"
  });

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = "export_citeen_copro_filtre.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* -----------------------------------------------------
   MINIMISATION PANEL
------------------------------------------------------ */
function minimizeSearchPanel() {
  if (searchPanelMinimized) return;
  const panel = document.getElementById("searchPanel");
  panel.classList.remove("expanded");
  panel.classList.add("mini");
  searchPanelMinimized = true;
}

/* -----------------------------------------------------
   R√âINITIALISATION
------------------------------------------------------ */
function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("syndicInput").value = "";
  document.getElementById("cpInput").value = "";
  document.getElementById("typeBienFilter").value = "";
  document.getElementById("anneeMinFilter").value = "";
  document.getElementById("anneeMaxFilter").value = "";
  document.getElementById("prixMinFilter").value = "";
  document.getElementById("prixMaxFilter").value = "";
  document.getElementById("noteDpeFilter").value = "";

  markerLayer.clearLayers();
  tertiaireLayer.clearLayers();

  hasSearched = false;
  searchPanelMinimized = false;
  lastFilteredRows = [];

  const panel = document.getElementById("searchPanel");
  panel.classList.remove("mini");
  panel.classList.add("expanded");

  map.fitBounds(boundsIDF);

  document.getElementById("status").innerText =
    "Recherche r√©initialis√©e.\nAucun point COPRO ni TERTIAIRE affich√©. Lancez une recherche.";
}

/* -----------------------------------------------------
   √âCOUTEURS
------------------------------------------------------ */
document.addEventListener("DOMContentLoaded", () => {
  const searchBtn     = document.getElementById("searchBtn");
  const resetBtn      = document.getElementById("resetBtn");
  const exportBtn     = document.getElementById("exportBtn");
  const searchInput   = document.getElementById("searchInput");
  const openingScreen = document.getElementById("openingScreen");
  const enterAppBtn   = document.getElementById("enterAppBtn");

  if (enterAppBtn && openingScreen) {
    enterAppBtn.addEventListener("click", () => {
      openingScreen.classList.add("hidden");
    });
  }

  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      hasSearched = true;
      applyFilters();
      minimizeSearchPanel();
    });
  }

  if (resetBtn) {
    resetBtn.addEventListener("click", resetFilters);
  }

  if (exportBtn) {
    exportBtn.addEventListener("click", exportFilteredToCSV);
  }

  if (searchInput) {
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        hasSearched = true;
        applyFilters();
        minimizeSearchPanel();
      }
    });
    searchInput.addEventListener("input", () => {
      if (hasSearched) applyFilters();
    });
  }

  const syndicInput    = document.getElementById("syndicInput");
  const cpInput        = document.getElementById("cpInput");
  const typeBienFilter = document.getElementById("typeBienFilter");
  const anneeMinFilter = document.getElementById("anneeMinFilter");
  const anneeMaxFilter = document.getElementById("anneeMaxFilter");
  const prixMinFilter  = document.getElementById("prixMinFilter");
  const prixMaxFilter  = document.getElementById("prixMaxFilter");
  const noteDpeFilter  = document.getElementById("noteDpeFilter");

  const liveApply = () => { if (hasSearched) applyFilters(); };

  if (syndicInput)    syndicInput.addEventListener("input",   liveApply);
  if (cpInput)        cpInput.addEventListener("input",       liveApply);
  if (typeBienFilter) typeBienFilter.addEventListener("change", liveApply);
  if (anneeMinFilter) anneeMinFilter.addEventListener("input", liveApply);
  if (anneeMaxFilter) anneeMaxFilter.addEventListener("input", liveApply);
  if (prixMinFilter)  prixMinFilter.addEventListener("input", liveApply);
  if (prixMaxFilter)  prixMaxFilter.addEventListener("input", liveApply);
  if (noteDpeFilter)  noteDpeFilter.addEventListener("change", liveApply);
});
</script>

</body>
</html>
